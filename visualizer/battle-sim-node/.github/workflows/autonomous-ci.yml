name: ðŸ¤– Autonomous CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run full test suite every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      run_simulations:
        description: 'Run balance simulations'
        required: false
        default: 'true'
      simulation_count:
        description: 'Number of simulations'
        required: false
        default: '100'

jobs:
  # ============================================
  # Quick Check - Fast feedback
  # ============================================
  quick-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint check
        run: npm run lint
        continue-on-error: true
      
      - name: Type check
        run: npm run type-check
        continue-on-error: true

  # ============================================
  # Test Suite - Full browser testing
  # ============================================
  test:
    runs-on: ubuntu-latest
    needs: quick-check
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Build project
        run: npm run build
      
      - name: Start dev server
        run: npm run dev:quick &
      
      - name: Wait for server
        run: npx wait-on http://localhost:5173 --timeout 30000
      
      - name: Run Playwright tests
        run: npx playwright test --reporter=html
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Balance Simulations - Headless game testing
  # ============================================
  simulate:
    runs-on: ubuntu-latest
    needs: test
    if: github.event.inputs.run_simulations != 'false'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Build project
        run: npm run build
      
      - name: Start dev server
        run: npm run dev:quick &
      
      - name: Wait for server
        run: npx wait-on http://localhost:5173 --timeout 30000
      
      - name: Run balance simulations
        run: |
          COUNT="${{ github.event.inputs.simulation_count || '100' }}"
          node scripts/batch-simulator.js "$COUNT" --export=all
      
      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        with:
          name: simulation-results
          path: simulation-results/
          retention-days: 90
      
      - name: Generate simulation summary
        run: |
          echo "## ðŸ“Š Simulation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f simulation-results/summary-*.json ]; then
            cat simulation-results/summary-*.json | jq -r '"- **Total Runs**: \(.summary.total)"' >> $GITHUB_STEP_SUMMARY
            cat simulation-results/summary-*.json | jq -r '"- **Success Rate**: \(.summary.success_rate * 100)%"' >> $GITHUB_STEP_SUMMARY
            cat simulation-results/summary-*.json | jq -r '"- **Avg Waves**: \(.summary.avg_waves)"' >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Build & Deploy
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    needs: [test, simulate]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for production
        run: npm run build
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: djmsqrvve.com

  # ============================================
  # Health Check - Monitor live site
  # ============================================
  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Check live site
        run: |
          curl -sf https://djmsqrvve.com/DarwinsIslandReHelixedWeb/ > /dev/null && \
            echo "âœ… Site is live" || \
            (echo "âŒ Site check failed" && exit 1)
      
      - name: Performance check
        run: |
          curl -s -w "\nTime: %{time_total}s\nSize: %{size_download}b\n" \
            https://djmsqrvve.com/DarwinsIslandReHelixedWeb/ > perf.txt
          cat perf.txt
